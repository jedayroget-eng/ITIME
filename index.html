<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cedro Aventuras - V3 Final</title>
    <style>
        :root { --primary: #2d5a27; --danger: #e74c3c; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding-bottom: 60px; }
        #login-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background: var(--primary); position: fixed; width: 100%; z-index: 2000; }
        .login-box { background: white; padding: 30px; border-radius: 15px; width: 300px; text-align: center; }
        input, select { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .btn-entrar { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #app-screen { display: none; padding: 15px; }
        header { background: white; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .panel { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .grid-veiculos { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; }
        .v-btn { padding: 15px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; }
        .time-controls { display: flex; gap: 5px; align-items: center; margin: 10px 0; }
        .btn-time { background: #ddd; border: none; padding: 10px; border-radius: 8px; cursor: pointer; flex: 1; font-weight: bold; }
        .cards-area { display: grid; grid-template-columns: repeat(auto-fill, minmax(310px, 1fr)); gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 10px; border-left: 8px solid var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .card.paused { border-left-color: #f1c40f; background: #fffdf5; }
        .card.expired { border-left-color: var(--danger); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.7; } }
        .btn-card { padding: 10px 5px; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; flex: 1; margin: 2px; font-size: 12px; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; cursor: pointer; border: none; }
        .pago { background: #d4edda; color: #155724; }
        .pendente { background: #f8d7da; color: #721c24; }
        .history { margin-top: 30px; background: white; padding: 20px; border-radius: 12px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        .total-row { background: #f8f9fa; font-weight: bold; font-size: 16px; }

        #container-avisos { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .modal-vencido-box { pointer-events: auto; background: #ff0000; color: white; padding: 25px; width: 90%; max-width: 350px; border-radius: 20px; text-align: center; border: 5px solid white; position: absolute; box-shadow: 0 0 50px rgba(0,0,0,0.5); animation: alert-pulse 0.5s infinite; }
        @keyframes alert-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        .close-x { position: absolute; top: 10px; right: 15px; font-size: 24px; font-weight: bold; cursor: pointer; color: white; }
        .btn-vencido { width: 100%; padding: 12px; margin-top: 8px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }

        #modal-ticket { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 6000; justify-content: center; align-items: center; }
        .ticket-content { background: white; padding: 20px; width: 250px; font-family: monospace; text-align: left; border-radius: 5px; }
        .btn-imprimir-final { width: 100%; background: #222; color: white; padding: 15px; border: none; margin-top: 15px; cursor: pointer; font-weight: bold; }

        @media print {
            body * { visibility: hidden; }
            #ticket-imprimir, #ticket-imprimir * { visibility: visible; }
            #ticket-imprimir { position: absolute; left: 0; top: 0; width: 58mm; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

<audio id="som-alerta" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

<div id="modal-ticket">
    <div class="ticket-content" id="ticket-imprimir">
        <div id="ticket-corpo"></div>
        <button class="btn-imprimir-final no-print" onclick="window.confirmarImpressao()">CONFIRMAR IMPRESS√ÉO</button>
        <button id="btn-cancelar-ticket" class="btn-imprimir-final no-print" style="background:#888" onclick="document.getElementById('modal-ticket').style.display='none'">FECHAR</button>
    </div>
</div>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color: var(--primary)">üå≤ Cedro Gest√£o</h2>
        <input type="text" id="user" placeholder="Usu√°rio">
        <input type="password" id="pass" placeholder="Senha">
        <button class="btn-entrar" onclick="window.tentarLogin()">ENTRAR</button>
    </div>
</div>

<div id="container-avisos"></div>

<div id="app-screen">
    <header>
        <div id="op-nome" style="font-weight: bold;">Op: ---</div>
        <div id="relogio" style="font-size: 18px; font-family: monospace;">00:00:00</div>
        <button onclick="location.reload()">SAIR</button>
    </header>

    <div class="panel">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
            <input type="text" id="nome-crianca" placeholder="Crian√ßa">
            <input type="text" id="nome-responsavel" placeholder="Respons√°vel">
        </div>
        <div class="time-controls">
            <button class="btn-time" onclick="window.setQuickTime(5)">5m</button>
            <button class="btn-time" onclick="window.setQuickTime(10)">10m</button>
            <button class="btn-time" onclick="window.setQuickTime(15)">15m</button>
            <button class="btn-time" style="background:#34495e; color:white" onclick="window.setQuickTime(9999)">‚àû Livre</button>
            <input type="number" id="tempo-padrao" value="10" style="width: 60px; text-align: center;">
            <select id="pg-status" style="width: 110px;">
                <option value="N√£o">PENDENTE</option>
                <option value="Sim">PAGO</option>
            </select>
        </div>
        <div class="grid-veiculos">
            <button class="v-btn" style="background:#95a5a6" onclick="window.iniciar('Branco')">üöó Branco</button>
            <button class="v-btn" style="background:#c0392b" onclick="window.iniciar('Vermelho')">üöó Vermelho</button>
            <button class="v-btn" style="background:#f1c40f; color:black" onclick="window.iniciar('Amarelo')">üö≤ Amarelo</button>
            <button class="v-btn" style="background:#ecf0f1; color:black; border: 1px solid #ccc;" onclick="window.iniciar('Triciclo Branco')">üö≤ Tric. Branco</button>
            <button class="v-btn" style="background:#e082ac" onclick="window.iniciar('Rosa')">üö≤ Rosa</button>
            <button class="v-btn" style="background:#34495e" onclick="window.iniciar('Patinete')">üõ¥ Patinete</button>
        </div>
    </div>

    <div class="cards-area" id="container-cards"></div>

    <div class="history">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>üìä Hist√≥rico</h3>
            <button onclick="window.limparRelatorio()" style="background:red; color:white; border:none; padding:5px 10px; border-radius:5px;">LIMPAR</button>
        </div>
        <table id="tabela-hist">
            <thead>
                <tr><th>Brinquedo</th><th>Crian√ßa</th><th>In√≠cio</th><th>Fim</th><th>Tempo</th><th>Valor</th><th>Status</th></tr>
            </thead>
            <tbody></tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="5" style="text-align:right">Soma Total:</td>
                    <td id="valor-total-hist" colspan="2">R$ 0,00</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, getDocs, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD3WIeOM21IkcjytZ9-We7vJjOV-dYq2IA",
        authDomain: "cedro-aventuras.firebaseapp.com",
        projectId: "cedro-aventuras",
        storageBucket: "cedro-aventuras.firebasestorage.app",
        messagingSenderId: "750741113990",
        appId: "1:750741113990:web:35783abcde7f8eb6f6d507"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const avisadosLocal = new Set();

    window.tentarLogin = () => {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        if (p === "1234" || u === "Jeday") {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';
            document.getElementById('op-nome').innerText = "Op: " + u;
            window.usuarioAtivo = u;
        } else { alert("Senha incorreta!"); }
    };

    window.setQuickTime = (v) => document.getElementById('tempo-padrao').value = v;

    window.ajustar = async (id, segundos) => {
        const docRef = doc(db, "ativos", id);
        const snap = await getDoc(docRef);
        if (!snap.exists()) return;
        const data = snap.data();
        const ms = segundos * 1000;
        if (data.pausado) {
            await updateDoc(docRef, { msRestantes: (data.msRestantes || 0) + ms });
        } else {
            const novoFim = (data.fimTimestamp || Date.now()) + ms;
            await updateDoc(docRef, { fimTimestamp: novoFim });
        }
        avisadosLocal.delete(id);
    };

    window.togglePausa = async (id, statusAtual) => {
        const docRef = doc(db, "ativos", id);
        const agora = Date.now();
        const snap = await getDoc(docRef);
        if (!statusAtual) {
            const restava = snap.data().fimTimestamp - agora;
            await updateDoc(docRef, { pausado: true, msRestantes: restava });
        } else {
            const novoFim = agora + snap.data().msRestantes;
            await updateDoc(docRef, { pausado: false, fimTimestamp: novoFim });
        }
    };

    window.iniciar = async (veiculo) => {
        const mins = parseInt(document.getElementById('tempo-padrao').value) || 10;
        const ehLivre = mins >= 9999;
        const agora = Date.now();
        await addDoc(collection(db, "ativos"), {
            veiculo, 
            crianca: document.getElementById('nome-crianca').value || "Cliente",
            responsavel: document.getElementById('nome-responsavel').value || "---",
            fimTimestamp: agora + (mins * 60 * 1000),
            timestamp: agora,
            pago: document.getElementById('pg-status').value,
            pausado: false,
            modalidadeLivre: ehLivre,
            msRestantes: (mins * 60 * 1000)
        });
        document.getElementById('nome-crianca').value = "";
    };

    window.confirmarImpressao = () => {
        window.print();
        const btnFechar = document.getElementById('btn-cancelar-ticket');
        btnFechar.innerText = "AGUARDE 10s...";
        btnFechar.disabled = true;
        setTimeout(() => {
            btnFechar.innerText = "FECHAR";
            btnFechar.disabled = false;
        }, 10000);
    };

    window.abrirTicket = async (id) => {
        const snap = await getDoc(doc(db, "ativos", id));
        const d = snap.data();
        const inicioStr = new Date(d.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        const fimStr = d.modalidadeLivre ? "Livre" : new Date(d.fimTimestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        document.getElementById('ticket-corpo').innerHTML = `<center>üå≤ CEDRO AVENTURAS üå≤</center><br>----------------------------<br><b>VE√çCULO: ${d.veiculo}</b><br><b>CRIAN√áA:</b> ${d.crianca.toUpperCase()}<br><b>RESP:</b> ${d.responsavel.toUpperCase()}<br><br><b>IN√çCIO:</b> ${inicioStr}<br><b>FIM:</b> ${fimStr}<br><br><center><b>STATUS: ${d.pago === 'Sim' ? 'PAGO' : 'PENDENTE'}</b></center>----------------------------<br>Op: ${window.usuarioAtivo || 'Admin'}`;
        document.getElementById('modal-ticket').style.display = 'flex';
    };

    window.finalizar = async (id) => {
        const snap = await getDoc(doc(db, "ativos", id));
        if (!snap.exists()) return;
        const d = snap.data();
        const agora = Date.now();
        const tempo = Math.max(1, Math.floor((agora - d.timestamp)/60000));
        
        const inicioFormat = new Date(d.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        const fimFormat = new Date(agora).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

        await addDoc(collection(db, "historico"), {
            veiculo: d.veiculo, 
            crianca: d.crianca, 
            inicio: inicioFormat,
            fim: fimFormat,
            tempo, 
            valor: tempo, 
            pago: d.pago, 
            data: agora
        });
        await deleteDoc(doc(db, "ativos", id));
        const aviso = document.getElementById(`aviso-${id}`);
        if(aviso) aviso.remove();
    };

    window.alternarPg = async (id, status) => {
        await updateDoc(doc(db, "ativos", id), { pago: status === 'Sim' ? 'N√£o' : 'Sim' });
    };

    window.mudarPgHist = async (id, status) => { 
        await updateDoc(doc(db, "historico", id), { pago: status === 'Sim' ? 'N√£o' : 'Sim' }); 
    };

    window.limparRelatorio = async () => {
        if(confirm("Limpar hist√≥rico?")){
            const s = await getDocs(collection(db, "historico"));
            const b = writeBatch(db);
            s.forEach(d => b.delete(d.ref));
            await b.commit();
        }
    };

    onSnapshot(collection(db, "ativos"), (snap) => {
        const container = document.getElementById('container-cards');
        const idsNoBanco = snap.docs.map(d => d.id);
        document.querySelectorAll('.card').forEach(card => {
            const id = card.id.replace('card-', '');
            if (!idsNoBanco.includes(id)) card.remove();
        });

        snap.docs.forEach(docSnap => {
            const d = docSnap.data();
            const id = docSnap.id;
            let card = document.getElementById(`card-${id}`);

            if (!card) {
                container.insertAdjacentHTML('beforeend', `
                    <div class="card" id="card-${id}">
                        <div style="display:flex; justify-content:space-between;">
                            <b>${d.veiculo}</b>
                            <span id="pg-${id}" class="badge" onclick="window.alternarPg('${id}', '${d.pago}')"></span>
                        </div>
                        <div id="timer-${id}" style="font-size:40px; font-weight:bold; margin:10px 0;">00:00</div>
                        <div style="font-size:14px; margin-bottom:10px;">Crian√ßa: ${d.crianca}</div>
                        <div style="display:flex;">
                            <button class="btn-card" style="background:green" onclick="window.ajustar('${id}', 60)">+1m</button>
                            <button class="btn-card" style="background:orange" onclick="window.ajustar('${id}', -60)">-1m</button>
                            <button class="btn-card" style="background:blue" id="btn-p-${id}">‚è∏</button>
                            <button class="btn-card" style="background:#444" onclick="window.abrirTicket('${id}')">üñ®Ô∏è</button>
                            <button class="btn-card" style="background:red" onclick="window.finalizar('${id}')">FIM</button>
                        </div>
                    </div>
                `);
                card = document.getElementById(`card-${id}`);
            }

            const badge = document.getElementById(`pg-${id}`);
            badge.innerText = d.pago === 'Sim' ? 'PAGO' : 'PENDENTE';
            badge.className = `badge ${d.pago === 'Sim' ? 'pago' : 'pendente'}`;
            badge.onclick = () => window.alternarPg(id, d.pago);

            if (window[`int-${id}`]) clearInterval(window[`int-${id}`]);
            window[`int-${id}`] = setInterval(() => {
                const tEl = document.getElementById(`timer-${id}`);
                const bP = document.getElementById(`btn-p-${id}`);
                if (!tEl) return;
                bP.onclick = () => window.togglePausa(id, d.pausado);
                const s = d.pausado ? Math.max(0, Math.floor(d.msRestantes / 1000)) : (d.modalidadeLivre ? Math.floor((Date.now() - d.timestamp)/1000) : Math.max(0, Math.floor((d.fimTimestamp - Date.now())/1000)));
                tEl.innerText = `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
                bP.innerText = d.pausado ? '‚ñ∂' : '‚è∏';

                if (!d.modalidadeLivre && s <= 0) {
                    card.classList.add('expired');
                    if (!avisadosLocal.has(id)) {
                        avisadosLocal.add(id);
                        document.getElementById('som-alerta').play();
                        const areaAvisos = document.getElementById('container-avisos');
                        if(!document.getElementById(`aviso-${id}`)) {
                            areaAvisos.insertAdjacentHTML('beforeend', `
                                <div class="modal-vencido-box" id="aviso-${id}">
                                    <span class="close-x" onclick="this.parentElement.remove()">√ó</span>
                                    <h2 style="margin:0">TEMPO ESGOTADO!</h2>
                                    <p style="font-size:20px; font-weight:bold; margin:10px 0;">${d.veiculo}</p>
                                    <p>${d.crianca}</p>
                                    <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:10px; margin-bottom:10px;">
                                        PAGAMENTO: <span class="badge" id="aviso-pg-${id}"></span>
                                    </div>
                                    <button class="btn-vencido" style="background:#2ecc71; color:white;" onclick="window.finalizar('${id}')">FINALIZAR</button>
                                </div>
                            `);
                        }
                    }
                    const pgAviso = document.getElementById(`aviso-pg-${id}`);
                    if(pgAviso) {
                        pgAviso.innerText = d.pago === 'Sim' ? 'PAGO' : 'PENDENTE';
                        pgAviso.className = `badge ${d.pago === 'Sim' ? 'pago' : 'pendente'}`;
                        pgAviso.onclick = () => window.alternarPg(id, d.pago);
                    }
                } else {
                    card.classList.remove('expired');
                }
            }, 1000);
        });
    });

    onSnapshot(query(collection(db, "historico"), orderBy("data", "desc")), (snap) => {
        const tb = document.querySelector("#tabela-hist tbody");
        const totalEl = document.getElementById('valor-total-hist');
        tb.innerHTML = "";
        let somaTotal = 0;
        
        snap.forEach(docSnap => {
            const h = docSnap.data();
            const valor = parseFloat(h.valor) || 0;
            somaTotal += valor;
            
            tb.innerHTML += `<tr>
                <td>${h.veiculo}</td>
                <td>${h.crianca}</td>
                <td>${h.inicio || '--:--'}</td>
                <td>${h.fim || '--:--'}</td>
                <td>${h.tempo}m</td>
                <td>R$ ${valor.toFixed(2).replace('.',',')}</td>
                <td>
                    <button class="badge ${h.pago === 'Sim' ? 'pago' : 'pendente'}" onclick="window.mudarPgHist('${docSnap.id}', '${h.pago}')">
                        ${h.pago === 'Sim' ? 'PAGO' : 'PENDENTE'}
                    </button>
                </td>
            </tr>`;
        });
        
        totalEl.innerText = `R$ ${somaTotal.toFixed(2).replace('.',',')}`;
    });

    setInterval(() => { document.getElementById('relogio').innerText = new Date().toLocaleTimeString(); }, 1000);
</script>
</body>
</html>